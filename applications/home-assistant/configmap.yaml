apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-config
  namespace: home-assistant
data:
  configuration.yaml: |
    # Core Configuration
    default_config:

    # HTTP Settings
    http:
      server_port: 8123

    # Prometheus Integration
    prometheus:
      namespace: homeassistant
      require_auth: true

    # API Settings
    api:

    # Lovelace in YAML mode for GitOps
    lovelace:
      mode: yaml
      resources:
        - url: /hacsfiles/lovelace-mushroom/mushroom.js
          type: module

    # Group Configuration
    # Note: Entity IDs use 'bedroom_' because that's how HA originally registered them
    # Zigbee2MQTT friendly_name changes don't affect existing HA entity IDs
    group:
      living_room_lights:
        name: Living Room Lights
        entities:
          - light.bedroom_left_1
          - light.bedroom_left_2
          - light.bedroom_middle_1
          - light.bedroom_middle_2
          - light.bedroom_right_1
          - light.bedroom_right_2

    # Include other configurations
    scene: !include scenes.yaml
    automation: !include automations.yaml

  ui-lovelace.yaml: |
    title: Home
    views:
      # ===== HOME TAB =====
      - title: Home
        path: home
        icon: mdi:home
        type: sections
        sections:
          - type: grid
            cards:
              - type: custom:mushroom-chips-card
                chips:
                  - type: weather
                    entity: weather.forecast_home
                    show_temperature: true
                    show_conditions: true
                  - type: template
                    icon: mdi:thermometer
                    content: "{{ states('sensor.living_room_sensor_temperature') }}Â°C"
                    tap_action:
                      action: navigate
                      navigation_path: /lovelace/climate
                  - type: template
                    icon: mdi:lightbulb-group
                    content: "{{ states.light | selectattr('state', 'eq', 'on') | list | count }}"
                    tap_action:
                      action: navigate
                      navigation_path: /lovelace/lights
                alignment: center

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Quick Actions
              - type: horizontal-stack
                cards:
                  - type: custom:mushroom-template-card
                    primary: All Off
                    icon: mdi:power
                    icon_color: red
                    tap_action:
                      action: call-service
                      service: homeassistant.turn_off
                      target:
                        entity_id:
                          - group.living_room_lights
                          - switch.hallway_lamp
                    layout: vertical
                    fill_container: true
                  - type: custom:mushroom-template-card
                    primary: Daylight
                    icon: mdi:white-balance-sunny
                    icon_color: amber
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.daylight
                    layout: vertical
                    fill_container: true
                  - type: custom:mushroom-template-card
                    primary: Relax
                    icon: mdi:sofa
                    icon_color: orange
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.evening_relax
                    layout: vertical
                    fill_container: true
                  - type: custom:mushroom-template-card
                    primary: Movie
                    icon: mdi:movie
                    icon_color: deep-purple
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.movie_mode
                    layout: vertical
                    fill_container: true

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Living Room
              - type: custom:mushroom-template-card
                primary: Lights
                secondary: "{{ states.light | selectattr('entity_id', 'search', 'living_room') | selectattr('state', 'eq', 'on') | list | count }} of 6 on"
                icon: mdi:sofa
                icon_color: "{% if states.light | selectattr('entity_id', 'search', 'living_room') | selectattr('state', 'eq', 'on') | list | count > 0 %}amber{% else %}disabled{% endif %}"
                tap_action:
                  action: navigate
                  navigation_path: /lovelace/lights
              - type: custom:mushroom-entity-card
                entity: sensor.living_room_sensor_temperature
                name: Temperature
                icon_color: red
              - type: custom:mushroom-entity-card
                entity: binary_sensor.bedroom_motion_occupancy
                name: Motion
                icon: mdi:motion-sensor

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Plugs
              - type: horizontal-stack
                cards:
                  - type: custom:mushroom-entity-card
                    entity: switch.hallway_lamp
                    name: Lamp
                    icon: mdi:lamp
                    icon_color: amber
                    tap_action:
                      action: toggle
                    layout: vertical
                  - type: custom:mushroom-entity-card
                    entity: switch.kitchen_heater
                    name: Heater
                    icon: mdi:radiator
                    icon_color: red
                    tap_action:
                      action: toggle
                    layout: vertical
                  - type: custom:mushroom-entity-card
                    entity: switch.dining_room_tv
                    name: TV
                    icon: mdi:television
                    icon_color: blue
                    tap_action:
                      action: toggle
                    layout: vertical

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Security
              - type: custom:mushroom-entity-card
                entity: binary_sensor.bedroom_motion_occupancy
                name: Motion
                icon: mdi:motion-sensor

      # ===== LIGHTS TAB =====
      - title: Lights
        path: lights
        icon: mdi:lightbulb-group
        type: sections
        sections:
          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Scenes
              - type: horizontal-stack
                cards:
                  - type: custom:mushroom-template-card
                    primary: Daylight
                    icon: mdi:white-balance-sunny
                    icon_color: amber
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.daylight
                    layout: vertical
                  - type: custom:mushroom-template-card
                    primary: Gaming
                    icon: mdi:controller
                    icon_color: blue
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.gaming_mode
                    layout: vertical
                  - type: custom:mushroom-template-card
                    primary: Movie
                    icon: mdi:movie
                    icon_color: deep-purple
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.movie_mode
                    layout: vertical
              - type: horizontal-stack
                cards:
                  - type: custom:mushroom-template-card
                    primary: Relax
                    icon: mdi:sofa
                    icon_color: orange
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.evening_relax
                    layout: vertical
                  - type: custom:mushroom-template-card
                    primary: Reading
                    icon: mdi:book-open-variant
                    icon_color: lime
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.night_reading
                    layout: vertical
                  - type: custom:mushroom-template-card
                    primary: Party
                    icon: mdi:party-popper
                    icon_color: pink
                    tap_action:
                      action: call-service
                      service: scene.turn_on
                      data:
                        entity_id: scene.party_mode
                    layout: vertical

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Living Room Lights
              - type: custom:mushroom-light-card
                entity: light.bedroom_left_1
                name: Left 1
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true
              - type: custom:mushroom-light-card
                entity: light.bedroom_left_2
                name: Left 2
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true
              - type: custom:mushroom-light-card
                entity: light.bedroom_middle_1
                name: Middle 1
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true
              - type: custom:mushroom-light-card
                entity: light.bedroom_middle_2
                name: Middle 2
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true
              - type: custom:mushroom-light-card
                entity: light.bedroom_right_1
                name: Right 1
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true
              - type: custom:mushroom-light-card
                entity: light.bedroom_right_2
                name: Right 2
                use_light_color: true
                show_brightness_control: true
                show_color_control: true
                collapsible_controls: true

      # ===== CLIMATE TAB =====
      - title: Climate
        path: climate
        icon: mdi:thermometer
        type: sections
        sections:
          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Temperature
              - type: custom:mushroom-entity-card
                entity: sensor.living_room_sensor_temperature
                name: Living Room
                icon: mdi:thermometer
                icon_color: red
              - type: custom:mushroom-entity-card
                entity: sensor.hallway_sensor_temperature
                name: Hallway
                icon: mdi:thermometer
                icon_color: orange

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Humidity
              - type: custom:mushroom-entity-card
                entity: sensor.living_room_sensor_humidity
                name: Living Room
                icon: mdi:water-percent
                icon_color: blue
              - type: custom:mushroom-entity-card
                entity: sensor.hallway_sensor_humidity
                name: Hallway
                icon: mdi:water-percent
                icon_color: cyan

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Heater Control
              - type: custom:mushroom-entity-card
                entity: switch.kitchen_heater
                name: Kitchen Heater
                icon: mdi:radiator
                icon_color: red
                tap_action:
                  action: toggle

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Temperature History
              - type: history-graph
                hours_to_show: 24
                entities:
                  - entity: sensor.living_room_sensor_temperature
                    name: Living Room
                  - entity: sensor.hallway_sensor_temperature
                    name: Hallway

      # ===== ENERGY TAB =====
      - title: Energy
        path: energy
        icon: mdi:lightning-bolt
        type: sections
        sections:
          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Current Power
              - type: custom:mushroom-entity-card
                entity: sensor.hallway_lamp_power
                name: Hallway Lamp
                icon: mdi:lamp
                icon_color: amber
              - type: custom:mushroom-entity-card
                entity: sensor.kitchen_heater_power
                name: Kitchen Heater
                icon: mdi:radiator
                icon_color: red
              - type: custom:mushroom-entity-card
                entity: sensor.dining_room_tv_power
                name: Dining Room TV
                icon: mdi:television
                icon_color: blue

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Total Energy Used
              - type: custom:mushroom-entity-card
                entity: sensor.hallway_lamp_energy
                name: Hallway Lamp
                icon: mdi:counter
              - type: custom:mushroom-entity-card
                entity: sensor.kitchen_heater_energy
                name: Kitchen Heater
                icon: mdi:counter
              - type: custom:mushroom-entity-card
                entity: sensor.dining_room_tv_energy
                name: Dining Room TV
                icon: mdi:counter

          - type: grid
            cards:
              - type: custom:mushroom-title-card
                title: Power History (24h)
              - type: history-graph
                hours_to_show: 24
                entities:
                  - entity: sensor.hallway_lamp_power
                    name: Lamp
                  - entity: sensor.kitchen_heater_power
                    name: Heater
                  - entity: sensor.dining_room_tv_power
                    name: TV

  scenes.yaml: |
    - name: "Wake Up"
      entities:
        group.living_room_lights:
          state: 'on'
          brightness: 1
          color_temp: 500
          transition: 1200
        switch.hallway_lamp:
          state: 'on'

    - name: "Daylight"
      entities:
        group.living_room_lights:
          state: 'on'
          brightness: 255
          color_temp: 250
          transition: 5

    - name: "Gaming Mode"
      entities:
        light.bedroom_left_1:
          state: 'on'
          brightness: 200
          rgb_color: [0, 0, 255]
        light.bedroom_left_2:
          state: 'on'
          brightness: 200
          rgb_color: [0, 0, 255]
        light.bedroom_right_1:
          state: 'on'
          brightness: 200
          rgb_color: [255, 0, 0]
        light.bedroom_right_2:
          state: 'on'
          brightness: 200
          rgb_color: [255, 0, 0]
        light.bedroom_middle_1:
          state: 'on'
          brightness: 50
          rgb_color: [148, 0, 211]
        light.bedroom_middle_2:
          state: 'on'
          brightness: 50
          rgb_color: [148, 0, 211]

    - name: "Movie Mode"
      entities:
        light.bedroom_left_1:
          state: 'on'
          brightness: 30
          rgb_color: [255, 69, 0]
        light.bedroom_left_2:
          state: 'on'
          brightness: 30
          rgb_color: [255, 69, 0]
        light.bedroom_right_1:
          state: 'on'
          brightness: 30
          rgb_color: [255, 69, 0]
        light.bedroom_right_2:
          state: 'on'
          brightness: 30
          rgb_color: [255, 69, 0]
        light.bedroom_middle_1:
          state: 'off'
        light.bedroom_middle_2:
          state: 'off'
        switch.hallway_lamp:
          state: 'off'

    - name: "Evening Relax"
      entities:
        group.living_room_lights:
          state: 'on'
          brightness: 128
          color_temp: 500
          transition: 5
        switch.hallway_lamp:
          state: 'on'

    - name: "Night Reading"
      entities:
        light.bedroom_middle_1:
          state: 'on'
          brightness: 150
          color_temp: 400
        light.bedroom_middle_2:
          state: 'on'
          brightness: 150
          color_temp: 400
        light.bedroom_left_1:
          state: 'on'
          brightness: 50
          color_temp: 500
        light.bedroom_left_2:
          state: 'on'
          brightness: 50
          color_temp: 500
        light.bedroom_right_1:
          state: 'on'
          brightness: 50
          color_temp: 500
        light.bedroom_right_2:
          state: 'on'
          brightness: 50
          color_temp: 500

    - name: "Party Mode"
      entities:
        light.bedroom_left_1:
          state: 'on'
          brightness: 255
          rgb_color: [255, 0, 0]
        light.bedroom_left_2:
          state: 'on'
          brightness: 255
          rgb_color: [0, 255, 0]
        light.bedroom_middle_1:
          state: 'on'
          brightness: 255
          rgb_color: [0, 0, 255]
        light.bedroom_middle_2:
          state: 'on'
          brightness: 255
          rgb_color: [255, 255, 0]
        light.bedroom_right_1:
          state: 'on'
          brightness: 255
          rgb_color: [255, 0, 255]
        light.bedroom_right_2:
          state: 'on'
          brightness: 255
          rgb_color: [0, 255, 255]

    - name: "Goodnight"
      entities:
        group.living_room_lights:
          state: 'off'
        switch.hallway_lamp:
          state: 'off'
        switch.dining_room_tv:
          state: 'off'

  automations.yaml: |
    - alias: "Workday Wake Up"
      trigger:
        platform: time
        at: "07:45:00"
      condition:
        - condition: time
          weekday:
            - mon
            - tue
            - wed
            - thu
            - fri
      action:
        - service: scene.turn_on
          target:
            entity_id: scene.wake_up
        - delay: "00:20:00"
        - service: scene.turn_on
          target:
            entity_id: scene.daylight

    - alias: "Evening Wind Down"
      trigger:
        platform: sun
        event: sunset
        offset: "+00:30:00"
      action:
        - service: scene.turn_on
          target:
            entity_id: scene.evening_relax
